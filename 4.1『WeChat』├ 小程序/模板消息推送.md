[微信小程序模板消息](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/template-message.html)
[服务端发送消息](https://developers.weixin.qq.com/miniprogram/dev/api-backend/templateMessage.send.html)


# 需求背景 : 小程序推送

"推送" 在小程序官方的叫法是模板消息。

基于微信的通知渠道，微信小程序为开发者提供了可以高效触达用户的模板消息能力，在用户本人与小程序页面有交互行为后触发，通过微信聊天列表中的服务通知可快捷进入查看消息，点击查看详情还能跳转到下发消息的小程序的指定页面。

微信小程序允许下发模板消息的条件分为两类：
1. 支付
当用户在小程序内完成过支付行为，可允许开发者向用户在7天内推送有限条数的模板消息（1次支付可下发3条，多次支付下发条数独立，互相不影响）
2. 提交表单
当用户在小程序内发生过提交表单行为且该表单声明为要发模板消息的，开发者需要向用户提供服务时，可允许开发者向用户在7天内推送有限条数的模板消息（1次提交表单可下发1条，多次提交下发条数独立，相互不影响）

通过提交表单来下发模板消息的限制为“允许开发者向用户在7天内推送有限条数的模板消息（1次提交表单可下发1条，多次提交下条数独立，相互不影响）”。

然而，用户1次触发7天内推送1条通知是明显不够用的。比如，签到功能利用模板消息的推送来提醒用户每天签到，只能在用户前一天签到的情况下，获取一次推送模板消息的机会，然后用于第二天向该用户发送签到提醒。但是很多情况下，用户在某一天忘记签到，系统便失去了提醒用户的权限，导致和用户断开了联系；再比如，系统想主动告知用户即将做某活动，然而由于微信小程序被动触发通知的限制，系统将无法主动推送消息。


# 如何突破模板消息的推送限制？

“提交表单”来实现模板消息的推送需要满足两个条件：

1.用户必须有表单提交行为，一次表单提交产生一次的推送机会。多用户之间相互独立。
2.推送机会的有效期有7天。超过则失效。
有这两个限制在就没办法通过技术手段来实现无限推送。我们只能通过其他非技术方案来实现。

突破口：“1次提交表单可下发1条，多次提交下发条数独立，相互不影响”

为了突破模板消息的推送限制，实现7天内任性推送，只需收集到足够的推送码，即每次提交表单时获取到的formId。

一个formId代表着开发者有向当前用户推送模板消息的一次权限。


# 小程序推送消息 与 公众号推送消息 

小程序 与 公众号 都有模板消息来实现推送
更详细的的差异可以参考 [微信公众号模版消息与小程序消息推送不同场景不同应用](https://www.cnblogs.com/holyson/p/8656420.html)
 
区别：
1.推送条数不同

　　　　公众号的消息推送（以下简称公推）可以采用接口在后台调用接口无限向用户推送消息

　　　　小程序的消息推送（一下简称微推）只能允许开发者向用户在7天内推送有限条数的模板消息（引用官方的话）解释过来是：很难实现无限制推送用户消息（但是可以实现）

2.出现位置不同

　　　　公推消息形式会在该公众号下，与微信消息等级相同

　　　　微推且消息出现在位置在“服务通知”里面

3.应用场景不同

　　　　公推最主要实现群发功能，以“被推送方”为主，实现从后台主动推给用户，无需用户操作，比如：用药提醒、礼品卡到期、日程提醒等

　　　　微推最主要是实现互动的推送，比如储值卡余额、完成支付、完成使用等，一次提交一次回馈，用户体验效果最佳

4.openid不同

　　　　俩着获取到的同一个微信用户的openid是不一样的


总的来说，公众号推送消息更好用，但是开发难度也更大。小程序也可以用关联的公众号来推送消息，
公众号消息模板接口文档：https://mp.weixin.qq.com/wiki?action=doc&id=mp1433751277&t=0.7295778082993709#0
参考：[小程序通过关联的公众号发送推送消息](https://blog.csdn.net/shikezhan/article/details/83476607)
小程序通过关联的公众号发送推送消息，先决条件：
1.需要微信开放平台、小程序、公众号3个账号，并将小程序和公众号关联到开放平台账号下。
2.在运营上和小程序上需要做些改变，要引导小程序用户关注公众号。
3.用户注册后关联手机号。

在项目中采用的方案是通过关联的公众号发送推送消息，如果用户没关注公众号，则通过短信的方式通知用户。如果实际情况与上述条件不符，那么该方案并不适合您



# 本编文章主要讲 小程序模板消息实现推送

# 准备工作

首先，在微信公众平台开通消息推送功能，并添加消息模板。

可以从模板库选择模板也可以创建一个模板，模板添加之后，模板ID我们接下来要用的。

发送模板消息需要用到accesstoken、formId和openID。

formID就是消息模板ID，openID我们最好在获取用户信息或用户登录时储存到全局变量里。


# 客户端

收集推送码

当表单组件中的属性report-submit=true时表示发送模板消息，提交表单便可以获取formId。
接下来只要对原先的页面进行改造，将用户原先绑定了点击事件的界面用表单组件中的button按钮组件来代替，
即把用户的交互点击的bindtap事件由表单bindsubmit来代替，从而捕获用户的点击事件来生成更多的推送码。

```
<form bindsubmit="submit" report-submit='true' >
  <button form-type="submit" type="default" size="mini">提交</button>
</form>


// 收集推送码
Page({
   formSubmit: funcition(e) {
		let formId = e.detail.formId;	// 获取formID
		this.collectFormIds(formId);   //保存推送码
		let type = e.detail.target.dataset.type; // 根据type执行点击事件
	},

   collectFormIds: function(formId) { 
		let formIds = app.globalData.globalFormIds; // 获取全局推送码数组
		if (!formIds)
				   formIds = [];
		let data = {
				   formId: formId,
				   expire: new Data().getTime() + 60480000 // 7天后的过期时间戳
		}
       formIds.push(data);
       app.globalData.globalFormIds = formIds;
	},
})
```
注意：表单的需要添加属性  report-submit='true'。



# 服务端

利用 form_id, template_id, openid 来实现推送

[文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/templateMessage.send.html)